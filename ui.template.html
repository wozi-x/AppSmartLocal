<!DOCTYPE html>
<html>

<head>
    <style>
        :root {
            --primary-color: #18A0FB;
            /* Figma Blue */
            --primary-hover: #0D86D8;
            --bg-color: #FFFFFF;
            --text-color: #333333;
            --label-color: #5E5E5E;
            /* Muted text for labels */
            --border-color: #E6E6E6;
            --input-bg: #FFFFFF;
            --success-bg: #E6F9F0;
            --success-color: #0D7A4A;
            --success-border: #A3E4C9;
            --error-bg: #FFEAEA;
            --error-color: #C53030;
            --error-border: #F5A3A3;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --radius-sm: 2px;
            /* Figma uses smaller radii */
            --radius-md: 6px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 11px;
            /* Figma standard is often 11px or 12px */
            color: var(--text-color);
            background: var(--bg-color);
            cursor: default;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .container {
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        /* Typography */
        .label {
            display: block;
            font-weight: 500;
            /* Inter Medium */
            margin-bottom: var(--spacing-xs);
            color: var(--label-color);
            font-size: 11px;
        }

        .hint {
            font-size: 10px;
            color: #888;
            margin-top: var(--spacing-xs);
            line-height: 1.4;
        }

        /* Inputs */
        input[type="text"],
        textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 11px;
            background: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.15s ease-in-out;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            /* Figma style focus */
        }

        input:hover,
        textarea:hover {
            border-color: #ccc;
        }

        input:focus:hover,
        textarea:focus:hover {
            border-color: var(--primary-color);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            line-height: 1.4;
        }

        textarea.tall {
            min-height: 100px;
            /* Reduced from 140px to save space */
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 11px;
            font-weight: 600;
            /* Inter SemiBold */
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            /* Standard button height */
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            border-color: #b3b3b3;
        }

        .btn-success {
            background: #1BC47D;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-success:hover {
            background: #14a366;
        }



        .section {
            display: flex;
            flex-direction: column;
        }

        .row {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        /* Status Notifications */
        .status {
            position: fixed;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 100;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 11px;
            display: none;
            line-height: 1.4;
            animation: fadeIn 0.2s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-2px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid var(--success-border);
        }

        .status.error {
            background: var(--error-bg);
            color: var(--error-color);
            border: 1px solid var(--error-border);
        }

        .status.info {
            background: #F0F9FF;
            color: #0077D4;
            border: 1px solid #BAE3FF;
        }

        /* Inline Error - now Block Error above button */
        /* Inline Error - now Block Error floating top */
        .error-message {
            position: fixed;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 101;
            font-size: 11px;
            color: var(--error-color);
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            display: none;
            animation: fadeIn 0.2s ease-in-out;
            text-align: left;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .error-message.show {
            display: block;
        }

        /* Selection Indicator */
        .selection-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: var(--spacing-sm) var(--spacing-md);
            background: #F5F5F5;
            border-radius: var(--radius-md);
            font-size: 11px;
            color: var(--text-color);
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .selection-indicator.active {
            background: #EDF5FA;
            border-color: #BDE0F5;
            color: var(--primary-color);
        }

        .selection-indicator .icon {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Icon placeholders - simplified as text for now, could be SVG */
        .icon-text {
            margin-right: 6px;
            font-size: 12px;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--text-color);
            margin-bottom: var(--spacing-xs);
        }

        .image-source-fields {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .image-source-fields.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- Status Area (Moved to top) -->
        <div id="status" class="status"></div>

        <!-- Selection Indicator -->
        <div id="selection-indicator" class="selection-indicator">
            <span id="selection-icon" class="icon">â¬œ</span>
            <span id="selection-text">No frame selected (REQUIRED)</span>
        </div>

        <!-- Input Section -->
        <div class="section">
            <label class="label" for="languages">Target Languages</label>
            <input type="text" id="languages" placeholder="e.g. de-DE, en-US, fr-FR, ja, ko, pt-BR, zh-Hans, zh-Hant"
                value="de-DE, en-AU, en-CA, en-GB, en-US, es-ES, fr-FR, hi, id, it, ja, ko, pl, pt-BR, ru, th, tr, vi, zh-Hans, zh-Hant">
            <div class="hint">Comma-separated locale codes</div>
        </div>

        <!-- Prompt Section -->
        <div class="section">
            <label class="label" for="prompt">Localization Prompt Template</label>
            <textarea id="prompt" class="tall">{{PROMPT}}</textarea>
        </div>

        <div class="section">
            <button id="generate" class="btn btn-primary">
                <span class="icon-text">ðŸ“‹</span> Generate & Copy Prompt
            </button>
        </div>

        <!-- Response Section -->
        <div class="section">
            <label class="label" for="response">Paste AI Response JSON</label>
            <textarea id="response" placeholder='{ "localizations": { "es": { ... } } }'></textarea>
        </div>

        <div class="section">
            <label class="checkbox-row" for="image-source-enabled">
                <input type="checkbox" id="image-source-enabled">
                <span>Replace images from local server</span>
            </label>
            <div id="image-source-fields" class="image-source-fields disabled">
                <label class="label" for="image-source-url">Local Image Server URL</label>
                <input type="text" id="image-source-url" placeholder="http://127.0.0.1:3000/image">
                <label class="label" for="image-source-root-path">Screenshots Root Path (Optional)</label>
                <input type="text" id="image-source-root-path"
                    placeholder="/Users/x/Developer/WoziAppOne/fastlane/screenshots/Wozi">
                <div class="hint">Start server: <code>npm run image-server -- --root "/Users/x/Developer/WoziAppOne/fastlane/screenshots/Wozi"</code></div>
                <div class="hint">Request format: <code>?locale=&lt;locale&gt;&amp;nodeName=&lt;normalizedNodeName&gt;&amp;rootPath=&lt;optionalPath&gt;</code></div>
            </div>
        </div>

        <div class="section">
            <div id="apply-error" class="error-message"></div>
            <button id="apply" class="btn btn-success">
                <span class="icon-text">âœ¨</span> Apply Localization
            </button>
        </div>

        <!-- Footer -->
        <div style="text-align: right; color: #888; font-size: 10px; margin-top: -8px;">
            v0.0.1
        </div>

    </div>

    <script>
        const languagesInput = document.getElementById('languages');
        const promptTextarea = document.getElementById('prompt');
        const responseTextarea = document.getElementById('response');
        const imageSourceEnabledInput = document.getElementById('image-source-enabled');
        const imageSourceUrlInput = document.getElementById('image-source-url');
        const imageSourceRootPathInput = document.getElementById('image-source-root-path');
        const imageSourceFields = document.getElementById('image-source-fields');
        const generateBtn = document.getElementById('generate');
        const applyBtn = document.getElementById('apply');
        const statusDiv = document.getElementById('status');
        const selectionIndicator = document.getElementById('selection-indicator');
        const selectionText = document.getElementById('selection-text');
        const selectionIcon = document.getElementById('selection-icon');
        const applyError = document.getElementById('apply-error');

        // Initial state
        generateBtn.disabled = true;
        generateBtn.title = "Please select a frame to generate prompt";
        generateBtn.style.opacity = "0.5";
        generateBtn.style.cursor = "not-allowed";

        // Initial state for Apply button
        applyBtn.disabled = true;
        applyBtn.style.opacity = "0.5";
        applyBtn.style.cursor = "not-allowed";
        applyBtn.title = "Paste response JSON or enable image replacement";

        // Store extracted data for validation
        let extractedData = null;
        let statusTimeout = null;

        // Debounce timers for saving
        let saveLocalesTimeout = null;
        let savePromptTimeout = null;
        let saveImageSourceTimeout = null;

        // Save locales with debounce (500ms delay)
        function saveLocales() {
            if (saveLocalesTimeout) clearTimeout(saveLocalesTimeout);
            saveLocalesTimeout = setTimeout(() => {
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-locales',
                        locales: languagesInput.value
                    }
                }, '*');
            }, 500);
        }

        // Save prompt with debounce (500ms delay)
        function savePrompt() {
            if (savePromptTimeout) clearTimeout(savePromptTimeout);
            savePromptTimeout = setTimeout(() => {
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-prompt',
                        prompt: promptTextarea.value
                    }
                }, '*');
            }, 500);
        }

        function isImageSourceEnabled() {
            return Boolean(imageSourceEnabledInput.checked);
        }

        function getImageSourceUrl() {
            return imageSourceUrlInput.value.trim();
        }

        function getImageSourceRootPath() {
            return imageSourceRootPathInput.value.trim();
        }

        function updateImageSourceFieldsState() {
            const enabled = isImageSourceEnabled();
            imageSourceFields.classList.toggle('disabled', !enabled);
        }

        function updateApplyButtonState() {
            const hasResponse = responseTextarea.value.trim().length > 0;
            const imageModeReady = isImageSourceEnabled() && getImageSourceUrl().length > 0;
            const canApply = hasResponse || imageModeReady;

            applyBtn.disabled = !canApply;
            applyBtn.style.opacity = canApply ? "1" : "0.5";
            applyBtn.style.cursor = canApply ? "pointer" : "not-allowed";

            if (canApply) {
                applyBtn.title = "Apply localization";
            } else if (isImageSourceEnabled()) {
                applyBtn.title = "Provide local image server URL or response JSON";
            } else {
                applyBtn.title = "Paste the AI response JSON or enable image replacement";
            }
        }

        function saveImageSource() {
            if (saveImageSourceTimeout) clearTimeout(saveImageSourceTimeout);
            saveImageSourceTimeout = setTimeout(() => {
                parent.postMessage({
                    pluginMessage: {
                        type: 'save-image-source',
                        imageSource: {
                            enabled: isImageSourceEnabled(),
                            baseUrl: getImageSourceUrl(),
                            rootPath: getImageSourceRootPath()
                        }
                    }
                }, '*');
            }, 500);
        }

        // Listen for changes on locales input
        languagesInput.addEventListener('input', saveLocales);

        // Listen for changes on prompt textarea
        promptTextarea.addEventListener('input', savePrompt);

        responseTextarea.addEventListener('input', () => {
            updateApplyButtonState();
            if (responseTextarea.value.trim().length > 0) hideStatus();
        });

        imageSourceEnabledInput.addEventListener('change', () => {
            updateImageSourceFieldsState();
            updateApplyButtonState();
            saveImageSource();
        });

        imageSourceUrlInput.addEventListener('input', () => {
            updateApplyButtonState();
            saveImageSource();
        });

        imageSourceRootPathInput.addEventListener('input', saveImageSource);

        function showStatus(message, type) {
            if (statusTimeout) {
                clearTimeout(statusTimeout);
                statusTimeout = null;
            }

            statusDiv.textContent = message;
            statusDiv.className = 'status show ' + type;

            // Auto-hide after 5 seconds
            statusTimeout = setTimeout(() => {
                hideStatus();
            }, 5000);
        }

        function hideStatus() {
            statusDiv.className = 'status';
            applyError.className = 'error-message';
            applyError.textContent = '';
        }

        function showApplyError(message) {
            applyError.textContent = message;
            applyError.className = 'error-message show';
        }

        function getTargetLanguages() {
            return languagesInput.value
                .split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        // Generate & Copy Prompt
        generateBtn.onclick = () => {
            const languages = getTargetLanguages();
            if (languages.length === 0) {
                showStatus('Please enter at least one target language', 'error');
                return;
            }
            hideStatus();

            parent.postMessage({
                pluginMessage: {
                    type: 'generate-prompt',
                    languages: languages,
                    promptTemplate: promptTextarea.value
                }
            }, '*');
        };

        // Apply Localization
        applyBtn.onclick = () => {
            const responseText = responseTextarea.value.trim();
            const imageSourceEnabled = isImageSourceEnabled();
            const imageSourceUrl = getImageSourceUrl();
            const imageSourceRootPath = getImageSourceRootPath();
            const hasResponse = responseText.length > 0;

            if (!hasResponse && !imageSourceEnabled) {
                showStatus('Please paste the AI response first', 'error');
                return;
            }

            if (imageSourceEnabled && imageSourceUrl.length === 0) {
                showApplyError('Image source URL is required when image replacement is enabled');
                return;
            }

            hideStatus();

            // Parse and validate JSON
            const languages = getTargetLanguages();
            if (languages.length === 0) {
                showApplyError('Please enter at least one target language');
                return;
            }

            let localizations = {};
            if (hasResponse) {
                let response;
                try {
                    response = JSON.parse(responseText);
                } catch (e) {
                    showApplyError('Invalid JSON format. Please check the response or generate a new one.');
                    return;
                }

                if (!response.localizations || typeof response.localizations !== 'object') {
                    showApplyError('Missing "localizations" object in response');
                    return;
                }

                localizations = response.localizations;

                const missingLanguages = languages.filter(lang => !localizations[lang]);
                if (missingLanguages.length > 0) {
                    showApplyError(`Missing translations for: ${missingLanguages.join(', ')}`);
                    return;
                }

                // Validate against extracted data if available
                if (extractedData && extractedData.texts) {
                    const textIds = extractedData.texts.map(t => t.id);
                    for (const lang of languages) {
                        const langData = localizations[lang];
                        const missingIds = textIds.filter(id => !langData.hasOwnProperty(id));
                        if (missingIds.length > 0) {
                            showStatus(`Missing text IDs for ${lang}: ${missingIds.length} texts`, 'error');
                            return;
                        }
                    }
                }
            } else if (!imageSourceEnabled) {
                showApplyError('Please paste AI response JSON or enable image replacement');
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'apply-localization',
                    localizations: localizations,
                    locales: languages,
                    imageSource: {
                        enabled: imageSourceEnabled,
                        baseUrl: imageSourceUrl,
                        rootPath: imageSourceRootPath
                    }
                }
            }, '*');
        };

        // Handle messages from plugin
        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'copy-to-clipboard') {
                try {
                    await navigator.clipboard.writeText(msg.text);
                } catch (e) {
                    const textarea = document.createElement('textarea');
                    textarea.value = msg.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
            } else if (msg.type === 'prompt-generated') {
                extractedData = msg.extractedData;
                const textCount = typeof msg.textCount === 'number' ? msg.textCount : 0;
                const imageCount = typeof msg.imageCount === 'number' ? msg.imageCount : 0;
                showStatus(`Prompt copied! Found ${textCount} text nodes and ${imageCount} image nodes.`, 'success');
            } else if (msg.type === 'prompt-error') {
                showStatus(msg.message, 'error');
            } else if (msg.type === 'apply-success') {
                const imageReplacedCount = typeof msg.imageReplacedCount === 'number' ? msg.imageReplacedCount : 0;
                const imageSkippedCount = typeof msg.imageSkippedCount === 'number' ? msg.imageSkippedCount : 0;
                const imageFailedCount = typeof msg.imageFailedCount === 'number' ? msg.imageFailedCount : 0;
                showStatus(`Success! Created ${msg.frameCount} localized frames. Images: ${imageReplacedCount} replaced, ${imageSkippedCount} skipped, ${imageFailedCount} failed.`, 'success');
            } else if (msg.type === 'apply-error') {
                showStatus(msg.message, 'error');
            } else if (msg.type === 'selection-changed') {
                const isValid = msg.isValid;
                const nodeName = msg.nodeName || '';
                const message = msg.message || '';

                // Update indicator
                if (isValid) {
                    selectionIndicator.classList.add('active');
                    selectionText.textContent = `Selected: ${nodeName}`;
                    // Enable button
                    generateBtn.disabled = false;
                    generateBtn.title = "Generate prompt for selected frame";
                    generateBtn.style.opacity = "1";
                    generateBtn.style.cursor = "pointer";
                } else {
                    selectionIndicator.classList.remove('active');
                    selectionText.textContent = message || 'No frame selected (REQUIRED)';
                    // Disable button
                    generateBtn.disabled = true;
                    generateBtn.title = message || "Please select a frame";
                    generateBtn.style.opacity = "0.5";
                    generateBtn.style.cursor = "not-allowed";
                }
            } else if (msg.type === 'load-saved-settings') {
                // Load saved locales if available
                if (msg.locales !== null && msg.locales !== undefined) {
                    languagesInput.value = msg.locales;
                }
                // Load saved prompt if available
                if (msg.prompt !== null && msg.prompt !== undefined) {
                    promptTextarea.value = msg.prompt;
                }
                imageSourceEnabledInput.checked = Boolean(msg.imageSourceEnabled);
                if (typeof msg.imageSourceUrl === 'string') {
                    imageSourceUrlInput.value = msg.imageSourceUrl;
                }
                if (typeof msg.imageSourceRootPath === 'string') {
                    imageSourceRootPathInput.value = msg.imageSourceRootPath;
                }
                updateImageSourceFieldsState();
                updateApplyButtonState();
            }
        };

        updateImageSourceFieldsState();
        updateApplyButtonState();

        // Notify plugin that UI is ready
        parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
    </script>
</body>

</html>
