<!DOCTYPE html>
<html>

<head>
    <style>
        :root {
            --primary-color: #18A0FB;
            /* Figma Blue */
            --primary-hover: #0D86D8;
            --bg-color: #FFFFFF;
            --text-color: #333333;
            --label-color: #5E5E5E;
            /* Muted text for labels */
            --border-color: #E6E6E6;
            --input-bg: #FFFFFF;
            --success-bg: #E6F9F0;
            --success-color: #0D7A4A;
            --success-border: #A3E4C9;
            --error-bg: #FFEAEA;
            --error-color: #C53030;
            --error-border: #F5A3A3;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --radius-sm: 2px;
            /* Figma uses smaller radii */
            --radius-md: 6px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 11px;
            /* Figma standard is often 11px or 12px */
            color: var(--text-color);
            background: var(--bg-color);
            cursor: default;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .container {
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        /* Typography */
        .label {
            display: block;
            font-weight: 500;
            /* Inter Medium */
            margin-bottom: var(--spacing-xs);
            color: var(--label-color);
            font-size: 11px;
        }

        .hint {
            font-size: 10px;
            color: #888;
            margin-top: var(--spacing-xs);
            line-height: 1.4;
        }

        /* Inputs */
        input[type="text"],
        textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 11px;
            background: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.15s ease-in-out;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 1px var(--primary-color);
            /* Figma style focus */
        }

        input:hover,
        textarea:hover {
            border-color: #ccc;
        }

        input:focus:hover,
        textarea:focus:hover {
            border-color: var(--primary-color);
        }

        textarea {
            resize: vertical;
            min-height: 60px;
            line-height: 1.4;
        }

        textarea.tall {
            min-height: 100px;
            /* Reduced from 140px to save space */
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: 11px;
            font-weight: 600;
            /* Inter SemiBold */
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            /* Standard button height */
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            border-color: #b3b3b3;
        }

        .btn-success {
            background: #1BC47D;
            color: white;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .btn-success:hover {
            background: #14a366;
        }



        .section {
            display: flex;
            flex-direction: column;
        }

        .row {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        /* Status Notifications */
        .status {
            position: fixed;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 100;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: 11px;
            display: none;
            line-height: 1.4;
            animation: fadeIn 0.2s ease-in-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-2px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.show {
            display: block;
        }

        .status.success {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid var(--success-border);
        }

        .status.error {
            background: var(--error-bg);
            color: var(--error-color);
            border: 1px solid var(--error-border);
        }

        .status.info {
            background: #F0F9FF;
            color: #0077D4;
            border: 1px solid #BAE3FF;
        }

        /* Inline Error - now Block Error above button */
        /* Inline Error - now Block Error floating top */
        .error-message {
            position: fixed;
            top: 12px;
            left: 12px;
            right: 12px;
            z-index: 101;
            font-size: 11px;
            color: var(--error-color);
            background: var(--error-bg);
            border: 1px solid var(--error-border);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            display: none;
            animation: fadeIn 0.2s ease-in-out;
            text-align: left;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .error-message.show {
            display: block;
        }

        /* Selection Indicator */
        .selection-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: var(--spacing-sm) var(--spacing-md);
            background: #F5F5F5;
            border-radius: var(--radius-md);
            font-size: 11px;
            color: var(--text-color);
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .selection-indicator.active {
            background: #EDF5FA;
            border-color: #BDE0F5;
            color: var(--primary-color);
        }

        .selection-indicator .icon {
            font-size: 12px;
            opacity: 0.7;
        }

        /* Icon placeholders - simplified as text for now, could be SVG */
        .icon-text {
            margin-right: 6px;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <div class="container">

        <!-- Status Area (Moved to top) -->
        <div id="status" class="status"></div>

        <!-- Selection Indicator -->
        <div id="selection-indicator" class="selection-indicator">
            <span id="selection-icon" class="icon">â¬œ</span>
            <span id="selection-text">No frame selected (REQUIRED)</span>
        </div>

        <!-- Input Section -->
        <div class="section">
            <label class="label" for="languages">Target Languages</label>
            <input type="text" id="languages" placeholder="e.g. es, fr, ja, zh, ko" value="es, fr, ja, zh, ko">
            <div class="hint">Comma-separated locale codes</div>
        </div>

        <!-- Prompt Section -->
        <div class="section">
            <label class="label" for="prompt">Localization Prompt Template</label>
            <textarea id="prompt" class="tall">{{PROMPT}}</textarea>
        </div>

        <div class="section">
            <button id="generate" class="btn btn-primary">
                <span class="icon-text">ðŸ“‹</span> Generate & Copy Prompt
            </button>
        </div>

        <!-- Response Section -->
        <div class="section">
            <label class="label" for="response">Paste AI Response JSON</label>
            <textarea id="response" placeholder='{ "localizations": { "es": { ... } } }'></textarea>
        </div>

        <div class="section">
            <div id="apply-error" class="error-message"></div>
            <button id="apply" class="btn btn-success">
                <span class="icon-text">âœ¨</span> Apply Localization
            </button>
        </div>

        <!-- Footer -->
        <div style="text-align: right; color: #888; font-size: 10px; margin-top: -8px;">
            v0.0.1
        </div>

    </div>

    <script>
        const languagesInput = document.getElementById('languages');
        const promptTextarea = document.getElementById('prompt');
        const responseTextarea = document.getElementById('response');
        const generateBtn = document.getElementById('generate');
        const applyBtn = document.getElementById('apply');
        const statusDiv = document.getElementById('status');
        const selectionIndicator = document.getElementById('selection-indicator');
        const selectionText = document.getElementById('selection-text');
        const selectionIcon = document.getElementById('selection-icon');
        const applyError = document.getElementById('apply-error');

        // Initial state
        generateBtn.disabled = true;
        generateBtn.title = "Please select a frame to generate prompt";
        generateBtn.style.opacity = "0.5";
        generateBtn.style.cursor = "not-allowed";

        // Initial state for Apply button
        applyBtn.disabled = true;
        applyBtn.style.opacity = "0.5";
        applyBtn.style.cursor = "not-allowed";
        applyBtn.title = "Paste the AI response JSON to validation";

        // Enable/Disable Apply button based on input
        responseTextarea.addEventListener('input', () => {
            const hasContent = responseTextarea.value.trim().length > 0;
            applyBtn.disabled = !hasContent;
            applyBtn.style.opacity = hasContent ? "1" : "0.5";
            applyBtn.style.cursor = hasContent ? "pointer" : "not-allowed";
            if (hasContent) hideStatus(); // Clear errors when typing
        });

        // Store extracted data for validation
        let extractedData = null;
        let statusTimeout = null;

        function showStatus(message, type) {
            if (statusTimeout) {
                clearTimeout(statusTimeout);
                statusTimeout = null;
            }

            statusDiv.textContent = message;
            statusDiv.className = 'status show ' + type;

            // Auto-hide after 5 seconds
            statusTimeout = setTimeout(() => {
                hideStatus();
            }, 5000);
        }

        function hideStatus() {
            statusDiv.className = 'status';
            applyError.className = 'error-message';
            applyError.textContent = '';
        }

        function showApplyError(message) {
            applyError.textContent = message;
            applyError.className = 'error-message show';
        }

        function getTargetLanguages() {
            return languagesInput.value
                .split(',')
                .map(s => s.trim())
                .filter(s => s.length > 0);
        }

        // Generate & Copy Prompt
        generateBtn.onclick = () => {
            const languages = getTargetLanguages();
            if (languages.length === 0) {
                showStatus('Please enter at least one target language', 'error');
                return;
            }
            hideStatus();

            parent.postMessage({
                pluginMessage: {
                    type: 'generate-prompt',
                    languages: languages,
                    promptTemplate: promptTextarea.value
                }
            }, '*');
        };

        // Apply Localization
        applyBtn.onclick = () => {
            const responseText = responseTextarea.value.trim();
            if (!responseText) {
                showStatus('Please paste the AI response first', 'error');
                return;
            }
            hideStatus();

            // Parse and validate JSON
            let response;
            try {
                response = JSON.parse(responseText);
            } catch (e) {
                showApplyError('Invalid JSON format. Please check the response or generate a new one.');
                return;
            }

            // Validate structure
            if (!response.localizations || typeof response.localizations !== 'object') {
                showApplyError('Missing "localizations" object in response');
                return;
            }

            const languages = getTargetLanguages();
            const missingLanguages = languages.filter(lang => !response.localizations[lang]);
            if (missingLanguages.length > 0) {
                showApplyError(`Missing translations for: ${missingLanguages.join(', ')}`);
                return;
            }

            // Validate against extracted data if available
            if (extractedData && extractedData.texts) {
                const textIds = extractedData.texts.map(t => t.id);
                for (const lang of languages) {
                    const langData = response.localizations[lang];
                    const missingIds = textIds.filter(id => !langData.hasOwnProperty(id));
                    if (missingIds.length > 0) {
                        showStatus(`Missing text IDs for ${lang}: ${missingIds.length} texts`, 'error');
                        return;
                    }
                }
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'apply-localization',
                    localizations: response.localizations
                }
            }, '*');
        };

        // Handle messages from plugin
        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'copy-to-clipboard') {
                try {
                    await navigator.clipboard.writeText(msg.text);
                } catch (e) {
                    const textarea = document.createElement('textarea');
                    textarea.value = msg.text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                }
            } else if (msg.type === 'prompt-generated') {
                extractedData = msg.extractedData;
                showStatus(`Prompt copied! Found ${msg.textCount} text nodes to localize.`, 'success');
            } else if (msg.type === 'prompt-error') {
                showStatus(msg.message, 'error');
            } else if (msg.type === 'apply-success') {
                showStatus(`Success! Created ${msg.frameCount} localized frames.`, 'success');
            } else if (msg.type === 'apply-error') {
                showStatus(msg.message, 'error');
            } else if (msg.type === 'selection-changed') {
                const isValid = msg.isValid;
                const nodeName = msg.nodeName || '';
                const message = msg.message || '';

                // Update indicator
                if (isValid) {
                    selectionIndicator.classList.add('active');
                    selectionText.textContent = `Selected: ${nodeName}`;
                    // Enable button
                    generateBtn.disabled = false;
                    generateBtn.title = "Generate prompt for selected frame";
                    generateBtn.style.opacity = "1";
                    generateBtn.style.cursor = "pointer";
                } else {
                    selectionIndicator.classList.remove('active');
                    selectionText.textContent = message || 'No frame selected (REQUIRED)';
                    // Disable button
                    generateBtn.disabled = true;
                    generateBtn.title = message || "Please select a frame";
                    generateBtn.style.opacity = "0.5";
                    generateBtn.style.cursor = "not-allowed";
                }
            }
        };

        // Notify plugin that UI is ready
        parent.postMessage({ pluginMessage: { type: 'ui-ready' } }, '*');
    </script>
</body>

</html>